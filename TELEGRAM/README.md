# 🤖 Telegram Bot - Пхукет Go

## 📋 Оглавление

- [Что это?](#что-это)
- [Текущий статус](#текущий-статус)
- [Архитектура](#архитектура)
- [Хостинг и деплой](#хостинг-и-деплой)
- [Функционал](#функционал)
- [Roadmap](#roadmap)
- [Документация](#документация)

---

## 🎯 Что это?

Telegram-бот **@phuketgos_bot** для автоматизации бронирования туров на Пхукете через систему **Deep Links**.

**Главная фишка:** Каждый тур имеет уникальную ссылку, которая открывает бота с **готовым описанием тура и кнопкой бронирования**.

**Пример:**
```
https://t.me/phuketgos_bot?start=rafting
```
→ Открывает бота с описанием тура "Рафтинг + СПА + ATV" и фото.

---

## ✅ Текущий статус (8 ноября 2025)

### 🟢 Что работает:

- ✅ **Бот запущен 24/7 на Koyeb** (бесплатный хостинг)
- ✅ **Deep Link система реализована** для тура "Рафтинг"
- ✅ **Аналитика групповых чатов** (отслеживает упоминания туров)
- ✅ **Health check сервер** на порту 8000 (для Koyeb)
- ✅ **Автоматический перезапуск** при падениях
- ✅ **Команды:** `/start`, `/getid`, `/stats`

### 🔧 Технические детали:

| Параметр | Значение |
|----------|----------|
| **Хостинг** | Koyeb (Сингапур) |
| **Стоимость** | $0/месяц (бесплатно навсегда) |
| **RAM** | 256 MB (используем ~50-100 MB) |
| **Uptime** | 24/7 (не засыпает) |
| **Deployment ID** | `8cd340f9` |
| **Commit** | `8153578` |
| **URL** | `small-robinia-phukeo-8b5e1e16.koyeb.app` |

---

## 🏗️ Архитектура

```
┌─────────────────────────────────────────┐
│   Пользователь (Telegram)              │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│   Deep Link                             │
│   t.me/phuketgos_bot?start=rafting     │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│   Telegram Bot API                      │
│   (Telegraf.js)                         │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│   welcome-message.js                    │
│   - Распознаёт параметр "rafting"      │
│   - Отправляет фото тура                │
│   - Показывает кнопки бронирования      │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│   HTTP Health Check Server              │
│   Порт 8000 (для Koyeb)                │
│   Endpoint: /health                     │
└─────────────────────────────────────────┘
```

---

## 🚀 Хостинг и деплой

### Почему Koyeb?

Мы **перебрали 15+ платформ** (см. `TELEGRAM_BOT/HOSTING_OPTIONS.md`) и выбрали Koyeb потому что:

1. ✅ **Бесплатно навсегда** (512 MB RAM бесплатно)
2. ✅ **НЕ требует кредитной карты** (в отличие от Fly.io)
3. ✅ **НЕ засыпает** (в отличие от Render.com - 15 мин)
4. ✅ **Docker поддержка** (гибкость настройки)
5. ✅ **Регион Сингапур** (близко к Таиланду = меньше задержек)

### ⚠️ ВАЖНО: Бесплатность гарантирована!

**Вопрос:** В Koyeb показывается "$0.000036/час" - это платно?

**Ответ:** НЕТ! Это **теоретическая стоимость** для расчёта лимитов. Для бесплатного тарифа:
- 🆓 **Первые 512 MB RAM = бесплатно** (мы используем 256 MB)
- 🆓 **2 GB диск = бесплатно** (мы используем ~500 MB)
- 🆓 **Никаких скрытых платежей**
- 🆓 **Карта НЕ требуется** (если бы требовалась оплата, попросили бы карту)

**Доказательство:** Мы специально выбрали Koyeb вместо Fly.io, потому что Fly.io **требовал карту**, а Koyeb - нет.

### Как работает деплой:

1. **GitHub** → Push code to `main` branch
2. **Koyeb** → Webhook получает уведомление
3. **Docker** → Собирает образ из `bot/Dockerfile`
4. **Deploy** → Запускает контейнер в Сингапуре
5. **Health Check** → Проверяет порт 8000 каждые 30 сек
6. **✅ Running** → Бот работает 24/7

**Время деплоя:** 2-3 минуты

**Auto-restart:** Да (если бот упадёт, Koyeb перезапустит)

---

## 🎯 Функционал

### 1. Deep Links (Главная фишка)

**Что это:**
Уникальная ссылка для каждого тура, которую можно вставить на сайт, в соцсети, QR-коды.

**Формат:**
```
https://t.me/phuketgos_bot?start=<tour_id>
```

**Пример реализации (тур "Рафтинг"):**

```javascript
// В welcome-message.js
bot.start(async (ctx) => {
  const startParam = ctx.startPayload; // "rafting"
  
  if (startParam === 'rafting') {
    await ctx.replyWithPhoto(
      { source: './images/rafting.jpg' },
      {
        caption: '🏞️ **Рафтинг + СПА + ATV**\n\n' +
                 '⏱️ Длительность: Полный день\n' +
                 '💰 Цена: 1800 ฿ взрослый, 1500 ฿ ребёнок\n\n' +
                 '✨ Программа:\n' +
                 '- Рафтинг 5 км по джунглям\n' +
                 '- СПА-массаж 1 час\n' +
                 '- ATV 30 минут\n' +
                 '- Обед + трансфер включены',
        parse_mode: 'Markdown',
        reply_markup: {
          inline_keyboard: [
            [{ text: '📅 Забронировать', callback_data: 'book_rafting' }],
            [{ text: '🗺️ Все туры', url: 'https://phukeo.com/#/tours' }],
            [{ text: '💬 Связаться с менеджером', url: 'https://t.me/Phuketga' }]
          ]
        }
      }
    );
  }
});
```

**Статус:**
- ✅ **Работает:** Рафтинг (`?start=rafting`)
- 🔜 **TODO:** Добавить 21 оставшийся тур

### 2. Аналитика групповых чатов

**Что делает:**
Бот подключается к группе **"ПХУКЕТ DA 🇹🇭"** (Chat ID: `-1002449303081`) и отслеживает:

- 📊 Количество сообщений
- 🏝️ Упоминания туров (Maya Bay, Phi Phi, Similan и т.д.)
- ❓ Вопросы о турах (ключевые слова: "где", "как", "сколько", "когда")
- 👥 Количество активных пользователей

**Команда:**
```
/stats - Показать статистику группы
```

**Пример вывода:**
```
📊 Статистика группы за 24 часа:

💬 Сообщений: 143
👥 Активных пользователей: 42
❓ Вопросов о турах: 18

🔥 Топ упоминаемых туров:
1. Maya Bay: 12 раз
2. Phi Phi: 8 раз
3. James Bond: 5 раз
4. Similan: 3 раза
5. Cheow Lan Lake: 2 раза
```

### 3. Служебные команды

- `/start` - Приветствие и главное меню
- `/getid` - Получить Chat ID группы (для админа)
- `/stats` - Статистика группы (только в группах)

### 4. Health Check сервер

**Зачем:**
Koyeb требует, чтобы сервис отвечал на HTTP-запросы (proof of life).

**Реализация:**
```javascript
const http = require('http');
const healthServer = http.createServer((req, res) => {
  res.writeHead(200, { 'Content-Type': 'application/json' });
  res.end(JSON.stringify({ 
    status: 'ok', 
    bot: 'running',
    uptime: process.uptime(),
    timestamp: new Date().toISOString()
  }));
});

healthServer.listen(8000);
```

**Endpoint:**
```
http://small-robinia-phukeo-8b5e1e16.koyeb.app:8000/health
```

**Ответ:**
```json
{
  "status": "ok",
  "bot": "running",
  "uptime": 3600,
  "timestamp": "2025-11-08T15:30:00.000Z"
}
```

---

## 📅 Roadmap

### ✅ Сделано (8 ноября 2025)

- [x] Создан бот @phuketgos_bot
- [x] Реализована Deep Link система
- [x] Добавлен тур "Рафтинг" с Deep Link
- [x] Подключена аналитика групповых чатов
- [x] Добавлен HTTP health check сервер
- [x] Создан Dockerfile для деплоя
- [x] Развёрнут на Koyeb (Сингапур)
- [x] Проверено: работает 24/7 бесплатно
- [x] Написана документация

### 🔜 TODO (Следующие шаги)

#### Фаза 1: Завершение Deep Links (1-2 часа)

- [ ] Добавить Deep Links для всех 22 туров:
  - [ ] Phi Phi 2 дня (`?start=phiphi2days`)
  - [ ] Острова Симилан (`?start=similan`)
  - [ ] Джеймс Бонд + Пхангнга (`?start=jamesbond`)
  - [ ] Озеро Чео Лан (`?start=cheolan`)
  - [ ] Остров Корал (`?start=coral`)
  - [ ] Майя Бэй рассвет (`?start=mayabay`)
  - [ ] Острова Рача (`?start=racha`)
  - [ ] Острова Кай (`?start=khai`)
  - [ ] 11 островов мега-тур (`?start=11islands`)
  - [ ] Жемчужины Андаманского моря (`?start=pearls`)
  - [ ] Слоновий заповедник (`?start=elephant`)
  - [ ] Достопримечательности Пхукета (`?start=sightseeing`)
  - [ ] ... (остальные 10 туров)

- [ ] Собрать все фото туров в `bot/images/`
- [ ] Создать JSON-конфиг с данными всех туров
- [ ] Протестировать все Deep Links

#### Фаза 2: Интеграция с сайтом (2-3 часа)

- [ ] Добавить Deep Link кнопки на каждую страницу тура на сайте
- [ ] Добавить QR-коды с Deep Links (для печатных материалов)
- [ ] Создать лендинг со всеми Deep Links для админа

#### Фаза 3: Автоматизация бронирований (3-4 часа)

- [ ] Реализовать обработчик кнопки "Забронировать"
- [ ] Собирать данные: имя, дата, количество человек
- [ ] Отправлять заявку администратору (@Phuketga)
- [ ] Интегрировать с Google Sheets / Supabase для хранения заявок

#### Фаза 4: Аналитика и улучшения (2-3 часа)

- [ ] Dashboard с аналитикой: какие Deep Links используются чаще
- [ ] Отслеживание конверсий (клики → бронирования)
- [ ] A/B тестирование текстов и фото туров
- [ ] Добавить inline-режим (поиск туров прямо в чатах)

#### Фаза 5: Telegram Mini App (5-7 часов)

- [ ] Создать Web App интерфейс (React)
- [ ] Интегрировать с Telegram WebApp API
- [ ] Добавить карту с локациями туров
- [ ] Календарь доступности и онлайн-оплата
- [ ] Подать заявку в официальный каталог Telegram Mini Apps

---

## 📚 Документация

### Основные файлы:

| Файл | Описание |
|------|----------|
| `TELEGRAM/README.md` | **Этот файл** - главный обзор проекта |
| `TELEGRAM/TELEGRAM_BOT/KOYEB_DEPLOY_GUIDE.md` | Пошаговая инструкция деплоя на Koyeb |
| `TELEGRAM/TELEGRAM_BOT/HOSTING_OPTIONS.md` | Сравнение 8 хостингов для бота |
| `TELEGRAM/TELEGRAM_BOT/ADVANCED_HOSTING_GUIDE.md` | Детальный гайд по 15 платформам + VPS |
| `bot/welcome-message.js` | Код бота (332 строки) |
| `bot/Dockerfile` | Docker-конфигурация для Koyeb |
| `bot/package.json` | Зависимости (telegraf, dotenv) |

### Конфигурация:

**Environment Variables (в Koyeb):**
```bash
BOT_TOKEN=8475227105:AAE7bu_y4nd8EpIpyQqBZg88F76yFyflWww
ADMIN_CHAT_ID=1217592929
```

**Dockerfile:**
```dockerfile
FROM node:20-alpine
WORKDIR /app
COPY bot/package*.json ./
RUN npm install --production
COPY bot/ ./
EXPOSE 8000
CMD ["node", "welcome-message.js"]
```

**Koyeb Settings:**
- Builder: Docker
- Dockerfile location: `bot/Dockerfile`
- Region: Singapore (sin)
- Instance: Nano (256 MB RAM)
- Port: 8000 (HTTP health check)

---

## 🔧 Разработка (локально)

### Требования:

- Node.js 20+
- npm 10+
- Telegram Bot Token (от @BotFather)

### Запуск:

```bash
cd bot/
npm install
node welcome-message.js
```

**Вывод:**
```
✅ Бот Пхукет Go запущен!
📱 Тестируй: https://t.me/phuketgos_bot
🗺️ Mini App: https://t.me/phuketgos_bot/app
📊 Режим аналитики групп активирован
🏥 Health check server running on port 8000
```

### Тестирование Deep Link:

```bash
# В браузере или Telegram
https://t.me/phuketgos_bot?start=rafting
```

### Логи:

Логи аналитики групп выводятся в консоль:
```
📊 [ПХУКЕТ "DA" 🇹🇭 | ЧАТ] Ольга: "кто нибудь был на Phi Phi?"
📊 [ПХУКЕТ "DA" 🇹🇭 | ЧАТ] Иван: "рекомендую Maya Bay на рассвете!"
```

---

## 🆘 Troubleshooting

### Бот не отвечает:

1. Проверь статус на Koyeb: https://app.koyeb.com/
2. Посмотри логи в Koyeb → Console
3. Проверь BOT_TOKEN в Environment Variables

### Health check failed:

1. Убедись что порт 8000 не занят
2. Проверь что HTTP-сервер запустился (лог: `🏥 Health check server running`)
3. Проверь настройки Health Check в Koyeb (TCP, port 8000)

### Деплой падает:

1. Проверь что `bot/Dockerfile` существует в GitHub
2. Убедись что путь `bot/Dockerfile` правильный (не `/Users/...`)
3. Проверь логи билда в Koyeb

---

## 💰 Стоимость

**Текущая конфигурация:**

| Компонент | Стоимость |
|-----------|-----------|
| **Koyeb Nano** | $0/месяц (бесплатно) |
| **GitHub** | $0/месяц (публичный репо) |
| **Telegram Bot API** | $0/месяц (бесплатно навсегда) |
| **Домен** | $0/месяц (используем koyeb.app поддомен) |
| **ИТОГО** | **$0/месяц** ✅ |

**Лимиты бесплатного тарифа Koyeb:**
- ✅ 512 MB RAM (используем 256 MB = 50%)
- ✅ 2 GB диск (используем ~500 MB = 25%)
- ✅ Безлимитный трафик
- ✅ Безлимитное время работы (24/7)

**Когда может понадобиться платный тариф:**
- ❌ Если бот начнёт использовать >512 MB RAM (маловероятно для текущего функционала)
- ❌ Если понадобится больше CPU (для сложных вычислений)
- ❌ Если захотим кастомный домен с SSL (можем остаться на .koyeb.app)

**Вывод:** При текущей нагрузке бот будет **бесплатным навсегда** ✅

---

## 📞 Контакты

- **Telegram бот:** [@phuketgos_bot](https://t.me/phuketgos_bot)
- **Админ:** [@Phuketga](https://t.me/Phuketga)
- **Группа:** [ПХУКЕТ "DA" 🇹🇭](https://t.me/+ID)
- **Сайт:** [phukeo.com](https://phukeo.com)
- **GitHub:** [johnda7/island-travel-echo-clone](https://github.com/johnda7/island-travel-echo-clone)

---

**Последнее обновление:** 8 ноября 2025  
**Версия:** 1.0.0  
**Статус:** ✅ Работает 24/7 на Koyeb
