// API endpoint –¥–ª—è GitHub Pages
// –§–∞–π–ª: public/api/send-telegram.html

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Telegram Proxy API</title>
</head>
<body>
<script>
// –ü—Ä–æ—Å—Ç–æ–π proxy —á–µ—Ä–µ–∑ HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É
console.log('üì° Telegram Proxy loaded');

window.addEventListener('message', async (event) => {
    console.log('üì® Received message from:', event.origin, event.data);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º origin –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (—Ä–∞–∑—Ä–µ—à–∞–µ–º prod, www –∏ localhost –¥–ª—è dev)
    const allowedOrigins = [
        'https://phukeo.com', 
        'https://www.phukeo.com',
        'http://localhost:8080', 
        'http://localhost:3000',
        'http://localhost:5173'
    ];
    
    // –¢–∞–∫–∂–µ —Ä–∞–∑—Ä–µ—à–∞–µ–º –µ—Å–ª–∏ origin –ø—É—Å—Ç–æ–π (—Ç–æ—Ç –∂–µ –¥–æ–º–µ–Ω) –∏–ª–∏ null
    const isAllowed = allowedOrigins.includes(event.origin) || 
                      event.origin === '' || 
                      event.origin === 'null' ||
                      event.origin === null;
    
    if (!isAllowed) {
        console.log('‚ùå Origin not allowed:', event.origin);
        return;
    }

    const { chat_id, text, requestId } = event.data;
    
    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –Ω–µ—Ç chat_id –∏–ª–∏ text (—ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å ready —Å–æ–æ–±—â–µ–Ω–∏–µ)
    if (!chat_id || !text) {
        console.log('‚è≠Ô∏è Skipping - no chat_id or text');
        return;
    }
    
    console.log('üì§ Sending to Telegram via Koyeb, chat_id:', chat_id);

    try {
        // ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Koyeb (—Ç–æ–∫–µ–Ω –±–µ–∑–æ–ø–∞—Å–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
        const KOYEB_NOTIFY_URL = 'https://small-robinia-phukeo-8b5e1e16.koyeb.app/api/notify';
        
        const response = await fetch(KOYEB_NOTIFY_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id, text, parse_mode: 'HTML' })
        });

        const result = await response.json();
        console.log('‚úÖ Telegram API response:', result);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞—Ç–Ω–æ
        if (event.source) {
            event.source.postMessage({
                requestId,
                result
            }, event.origin || '*');
        }

    } catch (error) {
        console.error('‚ùå Telegram API error:', error);
        if (event.source) {
            event.source.postMessage({
                requestId,
                error: error.message
            }, event.origin || '*');
        }
    }
});

// –°–æ–æ–±—â–∞–µ–º —á—Ç–æ –≥–æ—Ç–æ–≤—ã
console.log('üì° Sending ready signal to parent');
window.parent.postMessage({ ready: true }, '*');
</script>
</body>
</html>
